@model IEnumerable<SMS.Models.UserModel>
@using EF.Services;
@{
	ViewBag.Title = "Users";
	Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}
@using (Html.BeginForm())
{
	<div class="col-xs-12 col-md-12">
		<h3 style="text-align:left;font-weight:bold;">Users</h3>
		@if (!String.IsNullOrEmpty(ViewBag.Result))
		{
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<div class="alert alert-success" role="alert" id="success_message">Success <i class="glyphicon glyphicon-thumbs-up"></i> @ViewBag.Result</div>
				</div>
			</div>
		}
	</div>
	<div class="clearfix"></div>
	<div class="col-xs-12 col-md-12">
		<div class="input-group pull-right">
			@Html.ActionLink("Create User", "Create", "User", null, new { @class = "btn btn-primary" })<text>&nbsp;&nbsp;&nbsp;</text>
			<button class="btn btn-danger" type="button" id="delete-selected"><i class="fa fa-file-excel-o"></i>&nbsp;&nbsp;&nbsp;Delete</button>
		</div>
	</div>
	<div class="clearfix"></div>
	<div class="col-xs-12 col-md-12">
		<br />
		<div id="users-table" class="form-group">
			<table class="table custom-table" data-sorting="true" data-paging="true" data-page-size="10">
				<thead>
					<tr>
						<th data-breakpoints="xs sm md" data-class="expand" data-sortable="false" data-sort-ignore="true"><input type="checkbox" id="allcheck" value="allcheck" /></th>
						<th data-sort-ignore="true">Username</th>
						<th data-breakpoints="xs sm md" data-title="Active" data-sortable="false" data-sort-ignore="true">Active</th>
						<th data-breakpoints="xs sm md" data-title="Roles" data-sortable="false" data-sort-ignore="true">Roles</th>
						<th data-breakpoints="xs sm md" data-title="Approve" data-sortable="false">Approved</th>
						<th data-sortable="false" data-sort-ignore="true">Actions</th>
					</tr>
				</thead>
				<tbody>
					@foreach (var user in Model)
					{
						<tr>
							<td align="center"><input type="checkbox" id="@user.Id" class="checkboxGroups" value="@user.Id" /></td>
							<td align="center">@user.Username</td>
							<td>
								@if (user.IsActive)
								{ <a class="act-user" onclick="ToggleUser(@user.Id,'Act');" style="cursor:pointer;" data-content="@user.Id" title="Activate User"><i class="fa fa-check fa-2x"></i></a> }
								else
								{ <a class="act-user" onclick="ToggleUser(@user.Id,'DAct');" style="cursor:pointer;" title="Activate User"><i class="fa fa-remove fa-2x"></i></a> }
							</td>
							<td align="center">@user.AvailableRoles.Count</td>
							<td>
								@if (user.IsApproved)
								{
									<i class="fa fa-check fa-2x"></i>
								}
								else
								{ <a class="app-user" onclick="ActDctUser(@user.Id,'Act');" style="cursor:pointer;" data-content="@user.Id" title="Approve User"><i class="fa fa-remove fa-2x" aria-hidden="true"></i></a> }
							</td>
							<td align="center"><a href="@Url.Action("Edit", "User", new { user.Id })" id="@("edit_" + user.Id)" title="Edit"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a></td>
						</tr>
					}
				</tbody>
			</table>
		</div>
	</div>
	<script type="text/javascript">
		var selectedIds = [];
		$(document).ready(function () {
			//delete selected
			$('#delete-selected').click(function (e) {
				if (selectedIds.length > 0) {
					e.preventDefault();

					var postData = {
						selectedIds: selectedIds
					};
					addAntiForgeryToken(postData);

					$.ajax({
						cache: false,
						type: "POST",
						url: "@(Url.Action("DeleteSelected", "User"))",
						data: postData,
						complete: function (data) {
							alert("Users Deleted Successfully.");
							GetAllUsers();
						},
						error: function (xhr, ajaxOptions, thrownError) {
							alert(thrownError);
						},
						traditional: true
					});
					return false;
				}
			});

			$(document).on('click', '#allcheck', function () {
				$('.checkboxGroups').prop('checked', $(this).is(':checked')).change();
			});

			//wire up checkboxes.
			$('#users-table').on('change', 'input[type=checkbox][id!=allcheck]', function (e) {
				var $check = $(this);
				if ($check.is(":checked") == true) {
					var checked = jQuery.inArray($check.val(), selectedIds);
					if (checked == -1) {
						//add id to selectedIds.
						selectedIds.push($check.val());
					}
				}
				else {
					var checked = jQuery.inArray($check.val(), selectedIds);
					if (checked > -1) {
						//remove id from selectedIds.
						selectedIds = $.grep(selectedIds, function (item, index) {
							return item != $check.val();
						});
					}
				}
				updateMasterCheckbox();
			});
		});

		function updateMasterCheckbox() {
			var numChkBoxes = $('#users-table input[type=checkbox][id!=allcheck]').length;
			var numChkBoxesChecked = $('#users-table input[type=checkbox][id!=allcheck]:checked').length;
			$('#allcheck').attr('checked', numChkBoxes == numChkBoxesChecked && numChkBoxes > 0);
		}

		function ToggleUser(key, DeAct) {
			if (confirm(DeAct == 'Act' ? 'Do You Want To Activate This User ?' : 'Do You Want To DeActivate This User ?')) {
				$.ajax({
					cache: false,
					type: "POST",
					url: "@(Url.Action("ToggleUser", "User"))",
					data: { id: key },
					success: function (data) {
					},
					error: function (xhr, ajaxOptions, thrownError) {
						alert(thrownError);
					},
					traditional: true
				});
			} else {
			}
		}

		function ActDctUser(key) {
			if (confirm('Do You Want To Approve This User ?')) {
				$.ajax({
					cache: false,
					type: "POST",
					url: "@(Url.Action("ApproveUser", "User"))",
					data: { id: key },
					success: function (data) {
						location.reload();
					},
					error: function (xhr, ajaxOptions, thrownError) {
						alert(thrownError);
					},
					traditional: true
				});
			} else {
			}
		}


		function GetAllUsers() {
			$.ajax({
				cache: false,
				type: "GET",
				url: "@(Url.Action("GetAllUsers", "User"))",
				data: {},
				success: function (data) {
					if (data != null) {
						$("#users-table").html('');
						$("#users-table").html(data);
					}
				},
				error: function (xhr, ajaxOptions, thrownError) {
					alert(thrownError);
				},
				traditional: true
			});
		}
	</script>
}
<script type="text/javascript">
	$(document).ready(function () {
		// Initiallize Footable
		$('table').DataTable({

			"processing": true, // for show progress bar  
			"serverSide": true, // for process server side  
			"filter": true, // this is for disable filter (search box)  
			"orderMulti": false, // for disable multiple column at once  
			"pageLength": 5,

			"ajax": {
				"url": "/Demo/LoadData",
				"type": "POST",
				"datatype": "json"
			},

			"columnDefs":
			[{
					"targets": [0],
					"visible": false,
					"searchable": false
				},
				{
					"targets": [7],
					"searchable": false,
					"orderable": false
				},
				{
					"targets": [8],
					"searchable": false,
					"orderable": false
				},
				{
					"targets": [9],
					"searchable": false,
					"orderable": false
				}],

			"columns": [
				{ "data": "CustomerID", "name": "CustomerID", "autoWidth": true },
				{ "data": "CompanyName", "name": "CompanyName", "autoWidth": true },
				{ "data": "ContactName", "title": "ContactName", "name": "ContactName", "autoWidth": true },
				{ "data": "ContactTitle", "name": "ContactTitle", "autoWidth": true },
				{ "data": "City", "name": "City", "autoWidth": true },
				{ "data": "PostalCode", "name": "PostalCode", "autoWidth": true },
				{ "data": "Country", "name": "Country", "autoWidth": true },
				{ "data": "Phone", "name": "Phone", "title": "Status", "autoWidth": true },
				{
					"render": function (data, type, full, meta)
						{ return '<a class="btn btn-info" href="/Demo/Edit/' + full.CustomerID + '">Edit</a>'; }
				},
				{
					data: null, render: function (data, type, row) {
						return "<a href='#' class='btn btn-danger' onclick=DeleteData('" + row.CustomerID + "'); >Delete</a>";
					}
				}
			]
		});
	});
</script>