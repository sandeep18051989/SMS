@model SMS.Models.EventModel
<div class="panel-group">
	@if (Model.Id > 0)
	{
		<div class="panel panel-default">
			<div class="panel-body table-responsive">
				<table class="table table-bordered custom-table" style="width: 100% !important;" cellpadding="0" cellspacing="0" id="eventpictures-grid">
					<thead class="mdb-color lighten-5">
						<tr>
							<th>&nbsp;</th>
							<th class="text-left">Start Date</th>
							<th class="text-left">End Date</th>
							<th>Default</th>
							<th class="text-left">Display Order</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
				<script type="text/javascript">
					$(document).ready(function() {
						// Initiallize Datatable
						$('#eventpictures-grid').DataTable({
							"paging": false,
							"bLengthChange": false, //thought this line could hide the LengthMenu
							"bInfo": false,
							"processing": true, // for show progress bar
							"serverSide": true, // for process server side
							"filter": false, // this is for disable filter (search box)
							"orderMulti": true, // for disable multiple column at once
							"ajax": {
								"url": "/Admin/Event/LoadPictureGrid/@(Model.Id)",
								"type": "POST",
								"datatype": "json"
							},
							"aaSorting": [],
							"columns": [
								{
									"searchable": false,
									"title": "",
									"render": function (data, type, row) {
										if (type === "display") {
											return '<div class="thumb"><img style="max-width:100px;" src="' + row.PictureSrc + '" alt="" class="rounded-circle float-left"></div>';
										}
										return data;
									},
									"orderable": false,
									"className": 'text-center'
								},
								{
									"data": "StartDate",
									"title": "Start Date",
									"render": function(data, type, row) {
										if (type === "display") {
											var dateTemplate = '<div class="md-form form-group"><i class="fa fa-caledar-alt prefix"></i><input type="text" id="startpic_' + row.Id + '"';
                                            dateTemplate += ' data-value="' + (row.StartDate != null && row.StartDate !== "" ? row.StartDate : "") + '" value="' + (row.StartDate != null && row.StartDate !== "" ? row.StartDate : "") + '"';
											dateTemplate +=
                                                ' aria-label="Start Date" class="form-control datepicker" style= "width:200px"><script type="text/javascript">$(function () {';
                                            dateTemplate += ' $("#startpic_' + row.Id + '").pickadate({format: "dd mmmm, yyyy",min:new Date(),selectYears: false,selectMonths: false,max:new Date(moment("' + row.EndDate + '").format("DD MMM YYYY"))});';
											dateTemplate += 'var $input = $("#startpic_' + row.Id + '").pickadate();';
											dateTemplate += 'var picker = $input.pickadate("picker");';
                                            dateTemplate += 'picker.on({close: function() {$(document.activeElement).blur();$("#endpic_' + row.Id + '").pickadate("picker").set("min", new Date(moment($("#startpic_' + row.Id + '").val()).format("DD MMM YYYY")));},set: function(context) {  }});';
											dateTemplate += '});<\/script></div>';
											return dateTemplate;
										}
										return data;
									},
									"className": "dt-body-center",
									"orderable": false
								},
								{
									"data": "EndDate",
									"title": "End Date",
									"render": function(data, type, row) {
										if (type === "display") {
											var dateTemplate = '<div class="md-form form-group"><i class="fa fa-caledar-alt prefix"></i><input type="text" id="endpic_' + row.Id + '"';
                                            dateTemplate += ' data-value="' + (row.EndDate != null && row.EndDate !== "" ? row.EndDate : "") + '" value="' + (row.EndDate != null && row.EndDate !== "" ? row.EndDate : "") + '"';
                                            dateTemplate += ' aria-label="End Date" class="form-control datepicker" style= "width:200px"><script type="text/javascript">$(function () {';
                                            dateTemplate += ' $("#endpic_' + row.Id + '").pickadate({format:"dd mmmm, yyyy",selectYears: false,selectMonths: false,min:new Date(moment("' + row.StartDate + '").format("DD MMM YYYY"))});';
											dateTemplate += 'var $input1 = $("#endpic_' + row.Id + '").pickadate();';
											dateTemplate += 'var picker1 = $input1.pickadate("picker");';
                                            dateTemplate += 'picker1.on({close: function() {$(document.activeElement).blur();$("#startpic_' + row.Id + '").pickadate("picker").set("max", new Date(moment($("#endpic_' + row.Id + '").val()).format("DD MMM YYYY")));},set: function(context) {  }});';
											dateTemplate += '});<\/script></div>';
											return dateTemplate;
										}
										return data;
									},
									"className": "dt-body-center",
									"orderable": false
								},
								{
									"data": "IsDefault",
									"title": "Default",
									"render": function(data, type, row) {
										if (type === "display") {
											return '<div class="md-form form-group form-check"><input type="checkbox" name="defaultpicture" class="form-check-input" id="defaultpic_' +
												row.PictureId +
												'"><label class="form-check-label" for="default_' +
												row.PictureId +
												'"></label></div>';
										}
										return data;
									},
									"className": "text-center",
									"orderable": false
								},
								{
									"data": "DisplayOrder",
									"title": "Display Order",
									"render": function(data, type, row) {
										if (type === "display") {
											return '<div class="md-form form-group"><i class="fa fa-sort-alpha-asc prefix"></i><input type="number" id="' + row.PictureId + '" value="' + (row.DisplayOrder > 0 ? "0" : "") +'" aria-label="Display Order" class="form-control" style="width:150px"></div>';
										}
										return data;
									},
									"className": "dt-body-center",
									"orderable": false
								},
								{
									"title": "Actions",
									"orderable": false,
									"className": 'text-center',
									"render": function(data, type, row) {
										if (type === "display") {
											var dateTemplate = '<div class="md-form form-group"><button class="btn btn-info btn-rounded btn-sm my-0" id="picupd_' + row.PictureId + '" title="Update Picture"><i class="fa fa-refresh" aria-hidden="true">&nbsp;&nbsp;</i>Update</button>';
											dateTemplate += '&nbsp;&nbsp;<button class="btn btn-danger btn-rounded btn-sm my-0" id="picdel_' + row.PictureId + '" title="Delete Picture"><i class="fa fa-trash-o" aria-hidden="true">&nbsp;&nbsp;</i>Delete</button></div>';
											return dateTemplate;
										}
										return data;
									}
								}
							],
							"select": {
								"style": 'os',
								"selector": 'td:first-child'
							}
						});

						$('#addPicture').click(function() {
							var pictureId = $("#@Html.IdFor(model => model.InsertPictureModel.PictureId)").val();

							if (pictureId === 0) {
								alert('Upload picture first');
								return;
							}

							$('#addEventPicture').attr('disabled', true);

							var postData = {
								pictureId: pictureId,
								displayOrder: 0,
								isDefault: false,
								eventId: @Model.Id,
								startDate: moment(new Date()).format("DD MMM YYYY"),
								endDate: moment(new Date()).format("DD MMM YYYY")
							};

							addAntiForgeryToken(postData);

							$.ajax({
								cache: false,
								type: "POST",
								url: "@(Url.Action("EventPictureAdd", "Event"))",
								data: postData,
								success: function(data) {
									$('#addEventPicture').attr('disabled', false);
									$('.uploader').fineUploader('reset');
									$('#eventpictures-grid').trigger('reloadGrid');
								},
								error: function(xhr, ajaxOptions, thrownError) {
									console.log(xhr.responseText);
									$('#addEventPicture').attr('disabled', false);
								}
							});
						});

						$(document).on("click", 'button[id^=picdel_]', function () {
							var pictureId = parseInt($(this).attr('id').split('_')[1]);

							if (pictureId === 0) {
								alert('An error occurred while deleting picture!');
								return;
							}

							var postData = {
								id: pictureId
							};

							addAntiForgeryToken(postData);

							$.ajax({
								cache: false,
								type: "POST",
								url: "@(Url.Action("DeleteEventPicture", "Event"))",
								data: postData,
								success: function (data) {
									$('#eventpictures-grid').trigger('reloadGrid');
								},
								error: function(xhr, ajaxOptions, thrownError) {
									console.log(xhr.responseText);
									alert('Failed to delete event picture.');
								}
							});
						});

						$("input[name^=default_]").change(function() {
							if ($(this).prop('checked')) {
								$("input[name^=default_]").attr("checked", false);
								$(this).attr('checked', true).val(true);
							} else {
								$(this).attr('checked', false).val(false);
							}
						});
					});
				</script>
				@Html.EditorFor(model => model.InsertPictureModel.PictureId)
				@Html.ValidationMessageFor(model => model.InsertPictureModel.PictureId)
				&nbsp;
			</div>
			<div class="panel-footer">
				<button type="button" id="addPicture" class="btn btn-primary pull-right"><i class="fa fa-plus-circle"></i>&nbsp;&nbsp;Add Picture To Event</button>
			</div>
		</div>
	}
	else
	{
		<div class="panel panel-default">
			<div class="panel-body">
				<div class="alert alert-info" role="alert">
					<strong>Heads up!</strong> Please save event first to upload picture.
				</div>
			</div>
		</div>
	}
</div>