@model int
@using System.Web.Mvc;
@using EF.Services.Http;
@using EF.Services.Service;
@{
//register CSS and JS
	<link rel="stylesheet" type="text/css" href="~/Areas/Admin/Content/fineuploader.min.css" />
	<script type="text/javascript" src="~/Areas/Admin/Scripts/fineuploader.min.js"></script>
	//other variables
	var random = EF.Core.CodeHelper.GenerateRandomInteger();
	var clientId = "file" + random;
	var basePath = EF.Core.ContextHelper.Current.Resolve<IUrlHelper>().GetLocation(false);
	var fileService = EF.Core.ContextHelper.Current.Resolve<IFileService>();
	var file = fileService.GetFileById(Model);
}
@*fine uploader container*@
<div id="@clientId">
	<noscript>
		<p>
			Please enable JavaScript to use file uploader.
		</p>
		<!-- or put a simple form for upload here -->
	</noscript>
</div>
<input type="hidden" name="fileids" id="fileids" value="" />
@*fine uploader template (keep it synchronized to \Content\fineuploader\templates\default.html)*@
<script type="text/template" id="@(clientId)-qq-template">
	<div class="qq-uploader-selector qq-uploader">
		<div class="qq-upload-drop-area-selector qq-upload-drop-area" qq-hide-dropzone>
			<span>Drop File</span>
		</div>
		<div class="qq-upload-button-selector qq-upload-button">
			<div>Upload File</div>
		</div>
		<span class="qq-drop-processing-selector qq-drop-processing">
			<span>Processing</span>
			<span class="qq-drop-processing-spinner-selector qq-drop-processing-spinner"></span>
		</span>
		<ul class="qq-upload-list-selector qq-upload-list">
			<li>
				<div class="qq-progress-bar-container-selector">
					<div class="qq-progress-bar-selector qq-progress-bar"></div>
				</div>
				<span class="qq-upload-spinner-selector qq-upload-spinner"></span>
				<span class="qq-edit-filename-icon-selector qq-edit-filename-icon"></span>
				<span class="qq-upload-file-selector qq-upload-file"></span>
				<input class="qq-edit-filename-selector qq-edit-filename" tabindex="0" type="text">
				<span class="qq-upload-size-selector qq-upload-size"></span>
				<a class="qq-upload-cancel-selector qq-upload-cancel" href="#">Cancel</a>
				<a class="qq-upload-retry-selector qq-upload-retry" href="#">Retry</a>
				<a class="qq-upload-delete-selector qq-upload-delete" href="#">Delete</a>
				<span class="qq-upload-status-text-selector qq-upload-status-text"></span>
			</li>
		</ul>
	</div>
</script>

<script type="text/javascript">
    $(document).ready(function () {

        $("#@(clientId)").fineUploader({
            request: {
                endpoint: '@(Url.Action("AsyncFileUpload","Picture", new { Area = "admin" }))'
            },
            template: "@(clientId)-qq-template",
            multiple: false
        }).on("complete", function (event, id, name, responseJSON, xhr) {
            if (responseJSON.success) {
					 var cur_val = $('#fileids').val();
					 if (cur_val)
						 $('#fileids').val(cur_val + "," + responseJSON.pictureId);
					 else
						 $('#fileids').val(responseJSON.pictureId);

					 $("#file-list").show();
					 $("#file-grid-body").append('<tr id="' + responseJSON.pictureId + '"><th scope="row"><img src="@(basePath)Content/images/file.png" alt="" class="img-fluid z-depth-0"></th><td><button type="button" class="btn btn-sm btn-primary waves-effect waves-light" data-toggle="tooltip" data-placement="top" title="" id="removefile_' + responseJSON.pictureId + '" data-original-title="Remove item">X</button></td></tr >');
            }
        });

        $(document).on("click", "button[id^=removefile_]", function (e) {
			  var fileid = $(this).attr('id').split('_')[1];
			  $('#fileids').val(removeValue($('#fileids').val(), fileid ,","));
			  $(this).closest('tr').remove();
        });
	});

	var removeValue = function (list, value, separator) {
		separator = separator || ",";
		var values = list.split(separator);
		for (var i = 0; i < values.length; i++) {
			if (values[i] == value) {
				values.splice(i, 1);
				return values.join(separator);
			}
		}
		return list;
	}
</script>